generator client {
  provider = "prisma-client-js"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model Shop {
  id        String   @id @default(uuid())
  name      String
  type      ShopType
  createdAt DateTime @default(now())

  users     User[]
  items     Item[]
  invoices  Invoice[]
  stockLogs StockLog[]
}

enum ShopType {
  DISTRIBUTOR
  RETAIL
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         Role
  shopId       String
  shop         Shop     @relation(fields: [shopId], references: [id])
  refreshToken String?
  createdAt    DateTime @default(now())
}

enum Role {
  SALES
  STOCK_MANAGER
  ACCOUNTS
  ADMIN
}

model Item {
  id        String   @id @default(uuid())
  name      String
  sku       String
  price     Decimal
  shopId    String
  shop      Shop     @relation(fields: [shopId], references: [id])
  stockLogs StockLog[]

  @@unique([sku, shopId])
}

model StockLog {
  id          String   @id @default(uuid())
  itemId      String
  shopId      String
  change      Int
  reason      String
  referenceId String?
  createdAt   DateTime @default(now())

  item Item @relation(fields: [itemId], references: [id])
  shop Shop @relation(fields: [shopId], references: [id])

  @@index([shopId])
  @@index([itemId])
}

model Invoice {
  id          String   @id @default(uuid())
  number      String
  shopId      String
  total       Decimal
  createdById String
  createdAt   DateTime @default(now())

  shop  Shop @relation(fields: [shopId], references: [id])
  items InvoiceItem[]

  @@index([createdAt])
  @@index([shopId])
}

model InvoiceItem {
  id        String   @id @default(uuid())
  invoiceId String
  itemId    String
  quantity  Int
  price     Decimal

  invoice Invoice @relation(fields: [invoiceId], references: [id])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  shopId    String
  action    String
  entity    String
  entityId  String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([shopId])
  @@index([userId])
  @@index([createdAt])
}

model Transfer {
  id          String   @id @default(uuid())
  fromShopId  String
  toShopId    String
  createdById String
  createdAt   DateTime @default(now())

  items TransferItem[]
}

model TransferItem {
  id         String   @id @default(uuid())
  transferId String
  itemId     String
  quantity   Int

  transfer Transfer @relation(fields: [transferId], references: [id])
}